name: Build Docs

on:
  workflow_run:
    workflows: ["CMake Build Matrix"]
    branches: [main]
    types: 
      - completed

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Restore doxygen binary
        id: restore-doxygen
        uses: actions/cache@v3
        if: steps.extract-doxygen.outputs.cache-hit != 'true'
        with:
          path: ${{ env.HOME }}/doxygen
          key: doxygen-v1.9.2-${{ hashFiles('${HOME}/doxygen/**') }}
      
      - name: Extract doxygen
        id: extract-doxygen
        run: |
          wget https://www.doxygen.nl/files/doxygen-1.9.6.linux.bin.tar.gz -O doxygen.tar.gz
          tar xzf doxygen.tar.gz
          echo $GITHUB_WORKSPACE/doxygen >> $GITHUB_PATH
        env:
          DOXYGEN_CACHE_DIR: ${{ steps.restore-doxygen.outputs.cache-dir }}

      - name: Restore sphinx dependencies
        uses: actions/cache@v3
        with:
          path: /usr/local/lib/python3.9/site-packages
          key: install-dependencies-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            install-dependencies-  
      
      - name: Install dependencies
        id: install-dependencies
        run: |
          sudo apt-get update
          pip install sphinx sphinx-rtd-theme breathe myst_parser breathe sphinx_design pydata-sphinx-theme
        env:
          PIP_CACHE_DIR: ${{ steps.restore-dependencies-cache.outputs.cache-dir }}/pip
      
      - name: Cache documentation
        uses: actions/cache@v3
        with:
          path: 'docs'
          key: build-docs-${{ hashFiles('docs/**/*') }}
          restore-keys: |
            build-docs-

      - name: Build documentation
        id: build-docs
        run: | 
          echo "Generate doxygen xml for breathe to understand the source code"
          doxygen Doxyfile
          echo "build the documentation"
          cd docs
          make html


      - name: Deploy documentation
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # path to index!
          publish_dir: docs/build/html
